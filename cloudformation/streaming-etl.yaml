AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Streaming ETL Framework - One-Click Deployment
  Creates complete infrastructure: VPC, MSK, RDS, DMS, Glue, and utility Lambdas.
  Automatically sets up database tables, Kafka topics, and starts the pipeline.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Quick Start Configuration"
        Parameters:
          - EnvironmentName
      - Label:
          default: "Database Settings"
        Parameters:
          - RDSPassword
          - DBInstanceClass
      - Label:
          default: "Kafka Settings"
        Parameters:
          - MSKPassword
          - MSKInstanceType
      - Label:
          default: "Processing Settings"
        Parameters:
          - GlueWorkerType
          - GlueNumberOfWorkers
          - DMSInstanceClass
    ParameterLabels:
      EnvironmentName:
        default: "Environment Name (used as prefix for all resources)"
      RDSPassword:
        default: "RDS Database Password"
      MSKPassword:
        default: "Kafka SASL Password"

Parameters:
  EnvironmentName:
    Type: String
    Default: etl-streaming
    Description: Prefix for all resource names
    AllowedPattern: ^[a-z0-9-]+$
    ConstraintDescription: Must be lowercase alphanumeric with hyphens

  RDSPassword:
    Type: String
    Default: Amazon123
    NoEcho: true
    MinLength: 8
    MaxLength: 41
    Description: Password for RDS PostgreSQL (min 8 characters)

  MSKPassword:
    Type: String
    Default: KafkaAdmin1234
    NoEcho: true
    MinLength: 8
    MaxLength: 41
    Description: Password for Kafka SASL/SCRAM authentication (min 8 characters)

  DBInstanceClass:
    Type: String
    Default: db.t3.micro
    AllowedValues:
      - db.t3.micro
      - db.t3.small
      - db.t3.medium
    Description: RDS instance size

  MSKInstanceType:
    Type: String
    Default: kafka.t3.small
    AllowedValues:
      - kafka.t3.small
      - kafka.m5.large
    Description: MSK broker instance size

  DMSInstanceClass:
    Type: String
    Default: dms.t3.small
    AllowedValues:
      - dms.t3.small
      - dms.t3.medium
    Description: DMS replication instance size

  GlueWorkerType:
    Type: String
    Default: G.1X
    AllowedValues:
      - G.1X
      - G.2X
    Description: Glue worker type

  GlueNumberOfWorkers:
    Type: Number
    Default: 2
    MinValue: 2
    MaxValue: 10
    Description: Number of Glue workers

Mappings:
  # S3 bucket containing pre-packaged assets (scripts, configs, Lambda code)
  AssetLocations:
    us-east-1:
      Bucket: aws-streaming-etl-assets
      Prefix: v1.0.0
    us-west-2:
      Bucket: aws-streaming-etl-assets
      Prefix: v1.0.0

Resources:
  # ==========================================================================
  # VPC and Networking
  # ==========================================================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-private-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-private-2'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.101.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-1'

  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  # ==========================================================================
  # Security Groups
  # ==========================================================================
  MSKSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: MSK cluster security group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 9096
          ToPort: 9096
          CidrIp: 10.0.0.0/16
          Description: SASL/SCRAM from VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-msk-sg'

  MSKSecurityGroupSelfIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref MSKSecurityGroup
      IpProtocol: '-1'
      SourceSecurityGroupId: !Ref MSKSecurityGroup

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS PostgreSQL security group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 10.0.0.0/16
          Description: PostgreSQL from VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-rds-sg'

  GlueSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Glue jobs security group
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-glue-sg'

  GlueSecurityGroupSelfIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref GlueSecurityGroup
      IpProtocol: '-1'
      SourceSecurityGroupId: !Ref GlueSecurityGroup

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Lambda functions security group
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-lambda-sg'

  DMSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: DMS replication instance security group
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-dms-sg'

  # ==========================================================================
  # KMS Key for MSK SCRAM Secret
  # ==========================================================================
  MSKSecretKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for MSK SCRAM secret
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowRootAccess
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: AllowMSKAccess
            Effect: Allow
            Principal:
              Service: kafka.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: '*'

  # ==========================================================================
  # Secrets Manager
  # ==========================================================================
  RDSSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${EnvironmentName}/rds/credentials'
      SecretString: !Sub '{"username":"postgres","password":"${RDSPassword}"}'

  MSKSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'AmazonMSK_${EnvironmentName}_scram'
      KmsKeyId: !Ref MSKSecretKMSKey
      SecretString: !Sub '{"username":"kafkaadmin","password":"${MSKPassword}"}'

  # ==========================================================================
  # S3 Buckets
  # ==========================================================================
  DeltaBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-delta-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-assets-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  QuarantineBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-quarantine-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ==========================================================================
  # RDS PostgreSQL
  # ==========================================================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  DBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Family: postgres15
      Description: Enable logical replication for CDC
      Parameters:
        rds.logical_replication: '1'
        max_replication_slots: '10'
        max_wal_senders: '10'

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${EnvironmentName}-postgres'
      DBInstanceClass: !Ref DBInstanceClass
      Engine: postgres
      EngineVersion: '16.11'
      DBName: etldb
      MasterUsername: postgres
      MasterUserPassword: !Ref RDSPassword
      AllocatedStorage: 20
      StorageType: gp3
      DBSubnetGroupName: !Ref DBSubnetGroup
      DBParameterGroupName: !Ref DBParameterGroup
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      PubliclyAccessible: false
      MultiAZ: false
      BackupRetentionPeriod: 1
      DeletionProtection: false

  # ==========================================================================
  # MSK Cluster
  # ==========================================================================
  MSKConfiguration:
    Type: AWS::MSK::Configuration
    Properties:
      Name: !Sub '${EnvironmentName}-msk-config'
      ServerProperties: |
        auto.create.topics.enable=true
        delete.topic.enable=true
        default.replication.factor=2
        min.insync.replicas=1
        num.partitions=3
        log.retention.hours=24

  MSKCluster:
    Type: AWS::MSK::Cluster
    DependsOn: RDSInstance
    Properties:
      ClusterName: !Sub '${EnvironmentName}-msk'
      KafkaVersion: '3.5.1'
      NumberOfBrokerNodes: 2
      BrokerNodeGroupInfo:
        InstanceType: !Ref MSKInstanceType
        ClientSubnets:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroups:
          - !Ref MSKSecurityGroup
        StorageInfo:
          EBSStorageInfo:
            VolumeSize: 50
      ClientAuthentication:
        Sasl:
          Scram:
            Enabled: true
        Unauthenticated:
          Enabled: false
      ConfigurationInfo:
        Arn: !GetAtt MSKConfiguration.Arn
        Revision: 1
      EncryptionInfo:
        EncryptionInTransit:
          ClientBroker: TLS
          InCluster: true

  MSKScramSecretAssociation:
    Type: AWS::MSK::BatchScramSecret
    DependsOn: MSKCluster
    Properties:
      ClusterArn: !Ref MSKCluster
      SecretArnList:
        - !Ref MSKSecret

  # ==========================================================================
  # IAM Roles
  # ==========================================================================
  GlueRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-glue-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: GlueS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetBucketLocation
                  - s3:ListBucket
                Resource:
                  - !GetAtt DeltaBucket.Arn
                  - !GetAtt AssetsBucket.Arn
                  - !GetAtt QuarantineBucket.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub '${DeltaBucket.Arn}/*'
                  - !Sub '${AssetsBucket.Arn}/*'
                  - !Sub '${QuarantineBucket.Arn}/*'
        - PolicyName: GlueSecretsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: secretsmanager:GetSecretValue
                Resource: !Ref MSKSecret
        - PolicyName: GlueLogsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws-glue/*'
        - PolicyName: GlueCatalogAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - glue:GetDatabase
                  - glue:GetTable
                  - glue:GetTables
                  - glue:CreateTable
                  - glue:UpdateTable
                  - glue:GetConnection
                Resource:
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/${EnvironmentName}_db'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/${EnvironmentName}_db/*'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:connection/*'
        - PolicyName: GlueEC2Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                Resource: '*'

  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaVPCAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                Resource: '*'
        - PolicyName: LambdaLogsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${EnvironmentName}-*'
        - PolicyName: LambdaSecretsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: secretsmanager:GetSecretValue
                Resource:
                  - !Ref RDSSecret
                  - !Ref MSKSecret
        - PolicyName: LambdaS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt AssetsBucket.Arn
                  - !Sub '${AssetsBucket.Arn}/*'
                  - !GetAtt DeltaBucket.Arn
                  - !Sub '${DeltaBucket.Arn}/*'
        - PolicyName: LambdaAthenaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - athena:StartQueryExecution
                  - athena:GetQueryExecution
                  - athena:GetQueryResults
                Resource: '*'
              - Effect: Allow
                Action:
                  - glue:GetDatabase
                  - glue:GetTable
                  - glue:GetTables
                  - glue:CreateTable
                  - glue:UpdateTable
                Resource:
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/${EnvironmentName}_db'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/${EnvironmentName}_db/*'

  # ==========================================================================
  # DMS
  # ==========================================================================
  
  # DMS VPC Role - Required for DMS to manage VPC resources
  DMSVPCRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: dms-vpc-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: dms.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonDMSVPCManagementRole

  DMSSubnetGroup:
    Type: AWS::DMS::ReplicationSubnetGroup
    DependsOn: DMSVPCRole
    Properties:
      ReplicationSubnetGroupIdentifier: !Sub '${EnvironmentName}-dms-subnet-group'
      ReplicationSubnetGroupDescription: DMS subnet group
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  DMSReplicationInstance:
    Type: AWS::DMS::ReplicationInstance
    DependsOn: RDSInstance
    Properties:
      ReplicationInstanceIdentifier: !Sub '${EnvironmentName}-dms'
      ReplicationInstanceClass: !Ref DMSInstanceClass
      AllocatedStorage: 50
      EngineVersion: '3.5.2'
      MultiAZ: false
      PubliclyAccessible: false
      ReplicationSubnetGroupIdentifier: !Ref DMSSubnetGroup
      VpcSecurityGroupIds:
        - !Ref DMSSecurityGroup

  DMSSourceEndpoint:
    Type: AWS::DMS::Endpoint
    DependsOn: RDSInstance
    Properties:
      EndpointIdentifier: !Sub '${EnvironmentName}-source-postgres'
      EndpointType: source
      EngineName: postgres
      ServerName: !GetAtt RDSInstance.Endpoint.Address
      Port: 5432
      DatabaseName: etldb
      Username: postgres
      Password: !Ref RDSPassword
      SslMode: require

  DMSTargetEndpoint:
    Type: AWS::DMS::Endpoint
    DependsOn: MSKCluster
    Properties:
      EndpointIdentifier: !Sub '${EnvironmentName}-target-msk'
      EndpointType: target
      EngineName: kafka
      KafkaSettings:
        Broker: !GetAtt MSKCluster.BootstrapBrokerStringSaslScram
        Topic: cdc-default
        SecurityProtocol: sasl-ssl
        SaslUserName: kafkaadmin
        SaslPassword: !Ref MSKPassword
        MessageFormat: json
        IncludeNullAndEmpty: true

  DMSReplicationTask:
    Type: AWS::DMS::ReplicationTask
    DependsOn:
      - DMSReplicationInstance
      - DMSSourceEndpoint
      - DMSTargetEndpoint
    Properties:
      ReplicationTaskIdentifier: !Sub '${EnvironmentName}-cdc-task'
      MigrationType: full-load-and-cdc
      ReplicationInstanceArn: !Ref DMSReplicationInstance
      SourceEndpointArn: !Ref DMSSourceEndpoint
      TargetEndpointArn: !Ref DMSTargetEndpoint
      TableMappings: |
        {
          "rules": [
            {"rule-type": "selection", "rule-id": "1", "rule-name": "select-vehicles", "object-locator": {"schema-name": "public", "table-name": "vehicles"}, "rule-action": "include"},
            {"rule-type": "selection", "rule-id": "2", "rule-name": "select-drivers", "object-locator": {"schema-name": "public", "table-name": "drivers"}, "rule-action": "include"},
            {"rule-type": "selection", "rule-id": "3", "rule-name": "select-vehicle_telemetry", "object-locator": {"schema-name": "public", "table-name": "vehicle_telemetry"}, "rule-action": "include"},
            {"rule-type": "selection", "rule-id": "4", "rule-name": "select-deliveries", "object-locator": {"schema-name": "public", "table-name": "deliveries"}, "rule-action": "include"},
            {"rule-type": "selection", "rule-id": "5", "rule-name": "select-alerts", "object-locator": {"schema-name": "public", "table-name": "alerts"}, "rule-action": "include"},
            {"rule-type": "object-mapping", "rule-id": "6", "rule-name": "VehiclesMapping", "rule-action": "map-record-to-record", "kafka-target-topic": "cdc-vehicles", "object-locator": {"schema-name": "public", "table-name": "vehicles"}},
            {"rule-type": "object-mapping", "rule-id": "7", "rule-name": "DriversMapping", "rule-action": "map-record-to-record", "kafka-target-topic": "cdc-drivers", "object-locator": {"schema-name": "public", "table-name": "drivers"}},
            {"rule-type": "object-mapping", "rule-id": "8", "rule-name": "TelemetryMapping", "rule-action": "map-record-to-record", "kafka-target-topic": "cdc-vehicle_telemetry", "object-locator": {"schema-name": "public", "table-name": "vehicle_telemetry"}},
            {"rule-type": "object-mapping", "rule-id": "9", "rule-name": "DeliveriesMapping", "rule-action": "map-record-to-record", "kafka-target-topic": "cdc-deliveries", "object-locator": {"schema-name": "public", "table-name": "deliveries"}},
            {"rule-type": "object-mapping", "rule-id": "10", "rule-name": "AlertsMapping", "rule-action": "map-record-to-record", "kafka-target-topic": "cdc-alerts", "object-locator": {"schema-name": "public", "table-name": "alerts"}}
          ]
        }

  # ==========================================================================
  # Glue
  # ==========================================================================
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${EnvironmentName}_db'
        Description: Streaming ETL Delta Lake database

  GlueMSKConnection:
    Type: AWS::Glue::Connection
    DependsOn: MSKCluster
    Properties:
      CatalogId: !Ref AWS::AccountId
      ConnectionInput:
        Name: !Sub '${EnvironmentName}-msk-connection'
        ConnectionType: KAFKA
        ConnectionProperties:
          KAFKA_BOOTSTRAP_SERVERS: !GetAtt MSKCluster.BootstrapBrokerStringSaslScram
          KAFKA_SSL_ENABLED: 'true'
        PhysicalConnectionRequirements:
          AvailabilityZone: !Select [0, !GetAZs '']
          SecurityGroupIdList:
            - !Ref GlueSecurityGroup
          SubnetId: !Ref PrivateSubnet1

  GlueStreamingJob:
    Type: AWS::Glue::Job
    DependsOn: GlueMSKConnection
    Properties:
      Name: !Sub '${EnvironmentName}-streaming-job'
      Description: Streaming ETL with DQ, Transforms, and SCD2
      Role: !GetAtt GlueRole.Arn
      Command:
        Name: gluestreaming
        ScriptLocation: !Sub 's3://${AssetsBucket}/scripts/glue_streaming_job.py'
        PythonVersion: '3'
      DefaultArguments:
        '--job-language': python
        '--enable-glue-datacatalog': 'true'
        '--enable-continuous-cloudwatch-log': 'true'
        '--CONFIG_PATH': !Sub 's3://${AssetsBucket}/config/tables.yaml'
        '--extra-py-files': !Sub 's3://${AssetsBucket}/libs/PyYAML-6.0.1-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl,s3://${AssetsBucket}/libs/pydeequ-1.2.0-py3-none-any.whl,s3://${AssetsBucket}/scripts/deequ_analyzer.py'
        '--extra-jars': !Sub 's3://${AssetsBucket}/libs/deequ-2.0.4-spark-3.3.jar'
        '--datalake-formats': delta
        '--conf': 'spark.sql.extensions=io.delta.sql.DeltaSparkSessionExtension --conf spark.sql.catalog.spark_catalog=org.apache.spark.sql.delta.catalog.DeltaCatalog'
      Connections:
        Connections:
          - !Ref GlueMSKConnection
      GlueVersion: '4.0'
      WorkerType: !Ref GlueWorkerType
      NumberOfWorkers: !Ref GlueNumberOfWorkers

  # ==========================================================================
  # Utility Lambdas
  # ==========================================================================
  
  # SQL Runner Lambda - Execute SQL against RDS PostgreSQL
  SQLRunnerFunction:
    Type: AWS::Lambda::Function
    DependsOn: RDSInstance
    Properties:
      FunctionName: !Sub '${EnvironmentName}-sql-runner'
      Description: SQL runner utility for RDS PostgreSQL
      Runtime: python3.11
      Handler: sql_runner_lambda.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Timeout: 60
      MemorySize: 256
      Code:
        S3Bucket: !Ref AssetsBucket
        S3Key: lambda/sql_runner_lambda.zip
      Environment:
        Variables:
          RDS_HOST: !GetAtt RDSInstance.Endpoint.Address
          RDS_DATABASE: etldb
          RDS_USER: postgres
          RDS_SECRET_ARN: !Ref RDSSecret
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Layers:
        - !Sub 'arn:aws:lambda:${AWS::Region}:898466741470:layer:psycopg2-py311:1'

  # Kafka Admin Lambda - Topic management via SASL/SCRAM
  KafkaAdminFunction:
    Type: AWS::Lambda::Function
    DependsOn: MSKCluster
    Properties:
      FunctionName: !Sub '${EnvironmentName}-kafka-admin'
      Description: Kafka admin utility for topic management
      Runtime: python3.11
      Handler: kafka_admin_lambda.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Timeout: 300
      MemorySize: 256
      Code:
        S3Bucket: !Ref AssetsBucket
        S3Key: lambda/kafka_admin_lambda.zip
      Environment:
        Variables:
          KAFKA_BOOTSTRAP: !GetAtt MSKCluster.BootstrapBrokerStringSaslScram
          KAFKA_USERNAME: kafkaadmin
          MSK_SECRET_ARN: !Ref MSKSecret
          CONFIG_BUCKET: !Ref AssetsBucket
          CONFIG_KEY: config/tables.yaml
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2

  # Athena Table Creator Lambda - Auto-create Athena tables for Delta Lake
  AthenaTableCreatorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${EnvironmentName}-athena-table-creator'
      Description: Creates Athena tables for Delta Lake data
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Timeout: 120
      MemorySize: 256
      Code:
        ZipFile: |
          import boto3
          import json
          import os
          import yaml
          
          def lambda_handler(event, context):
              """Create Athena tables for Delta Lake tables based on config."""
              athena = boto3.client('athena')
              s3 = boto3.client('s3')
              
              database = os.environ.get('GLUE_DATABASE', 'etl_streaming_db')
              delta_bucket = os.environ.get('DELTA_BUCKET')
              config_bucket = os.environ.get('CONFIG_BUCKET')
              config_key = os.environ.get('CONFIG_KEY', 'config/tables.yaml')
              output_location = f's3://{delta_bucket}/athena-results/'
              
              # Load config from S3
              response = s3.get_object(Bucket=config_bucket, Key=config_key)
              config = yaml.safe_load(response['Body'].read().decode('utf-8'))
              
              results = {'created': [], 'errors': []}
              
              for table in config.get('tables', []):
                  if table.get('internal', False):
                      continue
                  
                  table_name = table['name']
                  delta_path = table.get('delta_path', f's3://{delta_bucket}/delta/{table_name}/')
                  
                  # Build column definitions from schema
                  columns = []
                  for col in table.get('schema', []):
                      col_type = col['type'].lower()
                      # Map types to Athena/Hive types
                      type_map = {
                          'integer': 'INT', 'int': 'INT',
                          'long': 'BIGINT', 'bigint': 'BIGINT',
                          'double': 'DOUBLE', 'float': 'DOUBLE',
                          'string': 'STRING', 'varchar': 'STRING',
                          'timestamp': 'TIMESTAMP',
                          'date': 'DATE',
                          'boolean': 'BOOLEAN'
                      }
                      athena_type = type_map.get(col_type, 'STRING')
                      columns.append(f"`{col['name']}` {athena_type}")
                  
                  # Add SCD2 columns
                  columns.extend([
                      '`_effective_from` TIMESTAMP',
                      '`_effective_to` TIMESTAMP',
                      '`_is_current` BOOLEAN',
                      '`_ingested_at` TIMESTAMP',
                      '`_operation` STRING'
                  ])
                  
                  col_defs = ',\n  '.join(columns)
                  
                  # Create table DDL for Delta Lake
                  ddl = f"""
                  CREATE EXTERNAL TABLE IF NOT EXISTS {database}.{table_name} (
                    {col_defs}
                  )
                  ROW FORMAT SERDE 'org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe'
                  STORED AS INPUTFORMAT 'org.apache.hadoop.hive.ql.io.SymlinkTextInputFormat'
                  OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
                  LOCATION '{delta_path}_symlink_format_manifest/'
                  """
                  
                  try:
                      response = athena.start_query_execution(
                          QueryString=ddl,
                          QueryExecutionContext={'Database': database},
                          ResultConfiguration={'OutputLocation': output_location}
                      )
                      results['created'].append({
                          'table': table_name,
                          'query_id': response['QueryExecutionId']
                      })
                  except Exception as e:
                      results['errors'].append({
                          'table': table_name,
                          'error': str(e)
                      })
              
              return {'statusCode': 200, 'body': json.dumps(results)}
      Environment:
        Variables:
          GLUE_DATABASE: !Sub '${EnvironmentName}_db'
          DELTA_BUCKET: !Ref DeltaBucket
          CONFIG_BUCKET: !Ref AssetsBucket
          CONFIG_KEY: config/tables.yaml

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC

  RDSEndpoint:
    Description: RDS PostgreSQL endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address

  MSKBootstrapServers:
    Description: MSK bootstrap servers (SASL/SCRAM)
    Value: !GetAtt MSKCluster.BootstrapBrokerStringSaslScram

  DeltaBucket:
    Description: S3 bucket for Delta Lake tables
    Value: !Ref DeltaBucket

  AssetsBucket:
    Description: S3 bucket for scripts and configs
    Value: !Ref AssetsBucket

  GlueJobName:
    Description: Glue streaming job name
    Value: !Ref GlueStreamingJob

  DMSTaskArn:
    Description: DMS replication task ARN
    Value: !Ref DMSReplicationTask

  SQLRunnerLambda:
    Description: SQL Runner Lambda function name
    Value: !Ref SQLRunnerFunction

  KafkaAdminLambda:
    Description: Kafka Admin Lambda function name
    Value: !Ref KafkaAdminFunction

  AthenaTableCreatorLambda:
    Description: Athena Table Creator Lambda function name
    Value: !Ref AthenaTableCreatorFunction

  NextSteps:
    Description: Post-deployment steps
    Value: |
      1. Upload scripts to S3: aws s3 sync src/ s3://<AssetsBucket>/scripts/
      2. Upload config to S3: aws s3 cp config/tables.yaml s3://<AssetsBucket>/config/
      3. Upload Deequ libs: aws s3 cp libs/ s3://<AssetsBucket>/libs/ --recursive
      4. Create RDS tables: aws lambda invoke --function-name <SQLRunnerLambda> --payload '{"sql":"..."}' out.json
      5. Create Kafka topics: aws lambda invoke --function-name <KafkaAdminLambda> --payload '{"action":"sync_from_config"}' out.json
      6. Start DMS task: aws dms start-replication-task --replication-task-arn <DMSTaskArn> --start-replication-task-type start-replication
      7. Start Glue job: aws glue start-job-run --job-name <GlueJobName>
      8. Create Athena tables: aws lambda invoke --function-name <AthenaTableCreatorLambda> out.json
